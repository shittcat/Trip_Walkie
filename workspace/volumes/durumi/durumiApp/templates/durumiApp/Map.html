{% load static %}
<html>
    <head>
        <meta charset = "utf-8" />
        
        <!--모바일 환경 뷰포트 대응-->
        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        
        <title> 함께 걸어가는 여행의 동반자! 여행거르미</title>
        
        <link rel="stylesheet" type="text/css" href=" {% static 'css/SearchList.css' %}">
        <link rel="stylesheet" type="text/css" href=" {% static 'css/uiButtons.css' %}">
        
        <link rel="manifest" href=" {% static 'manifest.json' %}">
        
        <link rel="apple-touch-icon" sizes="180x180" href="{% static 'image/apple-touch-icon.png' %}">
        <link rel="icon" type="image/png" sizes="32x32" href="{% static 'image/favicon-32x32.png' %}">
        <link rel="icon" type="image/png" sizes="16x16" href="{% static 'image/favicon-16x16.png' %}">
        <link rel="mask-icon" href="{% static 'image/safari-pinned-tab.svg' %}" color="#5bbad5">
        
        
        
        <style>
        
        body{ -ms-overflow-style: none; } 
        ::-webkit-scrollbar { display: none; } /*스크롤바 감추기 + 고정 */

        #searchDiv {
            position:relative; 
            top:2vh; 
            left:15vw; 
            transition : top 1s;
            z-index:2;
        }
        
        #searchBox{
            width:70vw;
            height: 4vh;
            padding: .9em .9em;
            border : none ;
            outline-style: none; 
            -webkit-appearance: none; 
            -moz-appearance: none; 
            font-family: inherit;
            font-size : 1.5em;
            
        	-moz-border-radius-topleft : 10px;  
            -moz-border-radius-topright: 10px;  
            -moz-border-radius-bottomleft: 10px;  
            -moz-border-radius-bottomright: 10px;  
            
            -webkit-border-top-left-radius: 10px;  
            -webkit-border-top-right-radius: 10px;  
            -webkit-border-bottom-left-radius: 10px;  
            -webkit-border-bottom-right-radius: 10px;  
        }
        
        </style>
        
        <!--/* 분류 버튼 css */-->
        <style>
        
        
        #catDiv{
            /*float : left;*/
            position : relative;
            top : 12vw ;
            left : 5vw ;
            width : 90vw;
            height : 10vh;
            z-index : 2;
            background: red;
        }
        
        .larCatDiv{ /*position 속성 선언되어있지 않으면 무조건 아래로 내려감.*/
            width : 10vw;
            height : 10vw;
            margin : 1vh 1vw;
            padding : 1vh 1vw;

            background: white;
            transition : top 0.5s, visibility 0.5s ,opacity 0.5s;
            z-index : 2;
            float : left;
        } 
        
        .larCatDiv.main{
            position : relative;
            left : -2vw;
            top : -2vh;
            background: blue;
            z-index : 3;
        }
        
        .larCatDiv.other{
            position : relative;
            display : none;
            left : -2vw;
            top : -2vh;
        }
        
        .larCatDiv img{
        	width: 10vw;
        	height: auto;
        	pointer-events: none 
        	/*이벤트 전파 순서 변경. bubbling -> capturing*/
        }
        
        
        .midCatDiv{
            float : left;
            position : relative;
            background: green;
        	height: 5vh;
        	top : 1vh;
        	z-index : 2;
        }
        
        .midCatDiv.main{
            display : block;
        }
        
        .midCatDiv.other{
            display : none;
        }
        
        .midCat{
            position : relative;
            /*top : 1vh;*/
            float : left;
            margin: 1vh 8vw;
            padding : 1vh 1vw;
            background: white;
            transition : top 0.5s, visibility 0.5s ,opacity 0.5s;
            z-index : 2;
        }
        
        </style>
        
        <!--상세 뷰 css -->
        <style>
            
            .itemOverlays{
                position : relative;
                white-space : normal;
                backface-visibility: hidden;
                transform-style: preserve-3d;
                transition: 0.5s;
            }
            
            .itemOverlays.noMark{
                display : none;    
            }
            
            .itemOverlays.setMark{
                display : block;    
            }
            
            .itemOverlays.place {
                top : -2vh;
                background: red;
            }
            
            .itemOverlays.picture {
                top : -20vh;
                transform: rotateY(180deg);
                background: green;
            }
            
        </style>
        
    </head>
<body scroll="overflow-x: hidden">
    <div id="popupDiv"> <!-- 팝업창 -->
        <button id="popCloseBtn">close</button>
    </div>
    <div id ="popup_mask" ></div> <!-- 팝업 배경 DIV. 마스크를 만들어서 씌우는 식으로 뒷 화면을 가리게함 . -->

    <!-- Map이 들어갈 위치를 정해주는 태그-->
    <div id = "map" style="width:100vw; height:100vh; z-index:1; position:absolute">
        <!-- searchBox의 위치를 정해주는 태그-->
        <div id="searchDiv" >
            <!--검색을 위한 FORM 태그-->
            <form id="searchForm">
                <!-- 보안을 위해 적어줌-->
                {% csrf_token %}
                <!-- 한개의 문자열로 검색하는 기능-->
                <input type=text name="searchBox" placeholder="여행지 검색" id="searchBox" >
                <input type=button id="search" value="확인">
                
            </form>
        </div>
    </div>
    
    <!-- div 태그 선언 영역 -->
    
    
    <div id ="openNote" onclick='openTripNote()'>opennote</div> 
    <div id ="noteDiv"></div>
    
    <div id ="openMenu" onclick='openMenu()'>openmenu</div> 
    <div id ="menuDiv"></div>
    
    <div id ="modeChange" onclick='modeChange()'>modechange</div> 
    
    <div id ="menuDiv"></div>

    <div id ="catDiv">
        
        <div class = "larCatDiv">
            <div id ="lar0" class ="larCatDiv main"  >
                <img src='{% static "image/icons/13.png" %}' name="larCat0">    
            </div>
            <div id ="lar1" class ="larCatDiv other" >
                <img src='' name="larCat1">
            </div>
            <div id ="lar2" class ="larCatDiv other" >
                <img src='' name="larCat2">
            </div>
            <div id ="lar3" class ="larCatDiv other" >
                <img src='' name="larCat3">    
            </div>
        </div>
        
        <div id='larCat0' class ="midCatDiv main" >
            <div class="midCat">0</div>
            <div class="midCat">0</div>
            <div class="midCat">0</div>
        </div>
            
        <div id='larCat1' class ="midCatDiv other">
            <div class="midCat">1</div>
            <div class="midCat">1</div>
            <div class="midCat">1</div>
        </div>
        
        <div id='larCat2' class ="midCatDiv other">
            <div class="midCat">2</div>
            <div class="midCat">2</div>
            <div class="midCat">2</div>
        </div>
        
        <div id='larCat3' class ="midCatDiv other">
            <div class="midCat">3</div>
            <div class="midCat">3</div>
            <div class="midCat">3</div>
        </div>
    </div>

    <div class = "itemOverlays">
        <div class = "itemOverlays noMark place">placeContent</div>
        <div class = "itemOverlays noMark picture">pictureContent</div>
    </div>
    
    <!-- 카카오맵 API를 이용한 지도 띄우기 -->
    {% include 'import.html' %}
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9a008f8471540e4e1fe8c0f01ed08a5a"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="{% static 'scripts/searchList.js' %}"></script>
    <script src="{% static 'scripts/uiButtons.js' %}"></script>
    
    <script> //페이지 로드시 초기화할 변수들 모음 
    var markers = [];
    var overlays = [];
    $(document).ready(function()  {
        SaveDiv = $("#popupDiv").html();
        checkNote = -1 ; //tripnote 올라왔는지 내려왔는지 체크 
        checkMenu = -1 ; //menu
        viewMode = 1 ; //place
        
        $('#element').on('scroll touchmove mousewheel', function(event) { /*스크롤바 감추기 + 고정 */
            event.preventDefault();
            event.stopPropagation();
            return false;
        });
        
    }); 
    </script>
    
    <!-- 분류 버튼 동작 스크립트 -->
    <script>
    
    $('.larCatDiv.other').on('click',function(event){
        var obj = $(event.target);
        var tmp = $('.larCatDiv.main').html();
        
        changeMidCat(obj,$('.larCatDiv.main'))
        $('.larCatDiv.main').html(obj.html())
        obj.html(tmp);
        
        $(".larCatDiv.other").slideUp();
        
        
    });
    
    function changeMidCat(catNum1,catNum2){
        var cat1 = catNum1.children('img').attr("name")
        var cat2 = catNum2.children('img').attr("name")
        $('#'+cat2).css("display","none");
        $('#'+cat1).animate({width:'toggle'},700);
    }
    
    $('.larCatDiv.main').on('click',function(evnet){
        $(".larCatDiv.other").slideToggle();
    });
    
    function openTripNote(){
        console.log(checkNote);
        if (checkNote == 1){ //노트 올라와 있는 상태 
            $("#noteDiv").css("top","130vh");
            $("#openNote").css("top","95vh");
            // $(".midCatDiv").css("display","block");
        }
        else if(checkNote == -1){//노트 내려와 있는 상태 
            $("#noteDiv").css("display","block"); //팝업창 display block
            $("#noteDiv").load("tripnote/");
            $("#noteDiv").css("top","70vh");
            $("#openNote").css("top","68vh");
            // $(".midCatDiv").css("display","none");
        }

        //다른 ui 숨기기
        $("#catDiv").slideToggle(10);
        $("#searchDiv").slideToggle();
        $("#modeChange").slideToggle();
        $("#openMenu").slideToggle();
        checkNote = checkNote * -1; 
       // alert("note")
    }
    
    </script> 

    <!--상세 뷰 스크립트-->
    <script>
    function SetMarker(inum){
        var list = $.parseJSON(GlobalList[inum]);
        // 마커 이미지의 이미지 크기 입니다
        var imageSize = new kakao.maps.Size(24, 35); 
        // 마커 이미지를 생성합니다    
        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize); 
        // 마커를 생성합니다
        var marker = new kakao.maps.Marker({
            map: map, // 마커를 표시할 지도
            position: new kakao.maps.LatLng(list['mapy'],list['mapx']), // 마커를 표시할 위치
            title : list['title'], // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
            image : markerImage, // 마커 이미지 
            mnum : inum
        });
        
        var content = 
                $('.itemOverlays').html()
    
        var overlay = new kakao.maps.CustomOverlay({
            content: content,  // 오버레이에 표시할 내용
            map: null,
            position: marker.getPosition(),   
        });
    
        markers.push(marker);
        overlays.push(overlay);
        
        kakao.maps.event.addListener(marker, 'click', function() {
            // markerClicked();
            var mtitle = marker.getTitle()
            var tmpcont = overlay.getContent().replace(/itemOverlays noMark/gi,'itemOverlays setMark');
            
            // 마커가 지도위에 처음으로 노출될 때의 스타일 설정 
           
            if(viewMode == 1){ //place view 일때
                tmpcont = tmpcont.replace(/place/,'place" style="width: 70vw; height: 40vh;"')              
            }
            else if(viewMode == -1){ //picture 일때
                tmpcont = tmpcont.replace(/place/,'place" style="transform: rotateY(0deg);"')
                tmpcont = tmpcont.replace(/picture/,'picture" style="width: 70vw; height: 40vh; transform: rotateY(0deg);"')  
            }
    
            var list = $.parseJSON(GlobalList[findListByTitle(mtitle)]);
            
            mtitle += "<br/> 도로명 주소 :"+list['addr1']
            mtitle += "<br/> 지번 주소 :"+list['addr2']
            
            tmpcont = tmpcont.replace(/placeContent/,mtitle);

            console.log(list);
            overlay.setContent(tmpcont);
            overlay.setMap(map);
        });
    }    
    
    function markerClicked() {
        $('.itemOverlays').css("display","block");
    }
    
    function findListByTitle(title){ //장소 이름으로 특정 JSON 리스트 찾아오기 
        for(idx in GlobalList){
            if($.parseJSON(GlobalList[idx])["title"] == title){
                return idx;
            }
        }
        return "fail" ;
    }
        
        
    function modeChange(){
        if(viewMode == 1){ //place -> picture 전환
            $(".place").css("width","0");
            $(".place").css("height","0");
            $(".place").css("transform","rotateY(180deg)");
            $(".picture").css("width","70vw");
            $(".picture").css("height","40vh");
            $(".picture").css("transform","rotateY(0deg)");
        }
        else if(viewMode == -1){ //picture -> place 전환 
            $(".place").css("width","70vw");
            $(".place").css("height","40vh");
            $(".place").css("transform","rotateY(0deg)");
            $(".picture").css("width","0");
            $(".picture").css("height","0");
            $(".picture").css("transform","rotateY(180deg)");
        }
        console.log(viewMode)
        viewMode *= -1;
    }
        
    </script>

    <script>
       	var container = document.getElementById('map');
		var options = {
			center: new kakao.maps.LatLng({{Map.yPos}} , {{Map.xPos}}),
            level: 3
		};
		
        
        var map = new kakao.maps.Map(container, options);


    // 엔터키의 기본기능인 submit 을 제거하고 엔터키를 입력시 search 버튼을 누른것과 같은 효과를 줌
    document.addEventListener('keydown', function(event) 
    {
        if (event.keyCode === 13) 
        {
            event.preventDefault();
            document.getElementById('search').click();
        };
    }, true);
    
    function panTo(y,x) //카카오맵 API를 이용해 지도의 중심을 이동시켜주는 함수
    {
        var moveLatLng = new kakao.maps.LatLng(y,x)
        map.panTo(moveLatLng)
    }
    </script>

    <!-- Ajax 를 이용한 template와 view 사이의 통신-->
    <script type="text/javascript">
    $('#search').click(function()
    {
        //form 에 있는 데이터를 한번에 모아줌 .serialize();
        var formData = $("#searchForm").serialize();
        console.log(formData);
        $.ajax
        ({
            cache: false,
            //어떤 View 와 데이터통신을 진행할것인지 url로 표시
            url : "{% url 'durumiApp:Pos' %}", // Pos view로 데이터를 전송 하면, Pos view 에서는 http로 결과값을 반환하므로, 해당 반환값을 받아서 data로 사용함. 
            //POST방식을 사용할것임
            type: 'POST',
            data: formData,
            success : function(data)
            {
                // 성공이라는 메시지를 띄워줌
                alert("성공");
                var jdata = data['result'];
                keywordSearch(jdata);
            },
            error : function(xhr, status,)
            {
                //데이터 통신이 원활이 이루어지지 않으면 실패라는 에러메시지를 띄워줌
                alert("실패");
                alert(xhr + ":" + status);
            },
        });
    })
</script>
